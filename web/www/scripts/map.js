function initMap(){centerPosition=new google.maps.LatLng(opts.lat,opts.lng),mainMap=new google.maps.Map(document.getElementById("map_canvas"),{zoom:defaultZoom,minZoom:defaultMinZoom,maxZoom:defaultMaxZoom,disableDefaultUI:!0,scrollwheel:!1,disableDoubleClickZoom:!0,styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]}),google.maps.event.addListenerOnce(mainMap,"idle",function(){return mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),"post-offline"==viewPage?(isLogin||$(".postSearch input").keydown(function(t){return t.preventDefault(),guestAction()}),!0):void require(["jquery","jquery-ui"],function(){!isLogin||"post"!=viewPage&&"posts"!=viewPage||require(["textarea_autosize"]),$(function(){if("post"==viewPage){var t=$("form.postSearch").submit(function(t){t.preventDefault(),guestAction()});postSearch_searchButton(t),postMarkers[0]=postList_tooltipmarker({map:mainMap,id:0,icon:postIcon,position:[opts.lat,opts.lng],content:function(t,e,o,a){$(".ui-tooltip-content",a.tooltip).html(userAddressTooltip(post.address,post.owner.image)),a.tooltip.position($(o.target).tooltip("option","position"))},openTooltip:!0});var e=$(".post[data-id="+post.id+"]").show();return postItem_renderContent(post.id,e),$("a.user_avatar[href=#],a.user_name[href=#]").click(function(t){t.preventDefault(),guestAction()}),!0}userPosition=new google.maps.LatLng(user.location[0],user.location[1]),$("form.postSearch").each(function(){var t=$(this);""!==$.trim($("[name=keywords]",t).val())?postSearch_clearButton(t):postSearch_searchButton(t)}),areaCircle=new googleMapsAreaCircle({map:mainMap,center:offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),radius:renderRadius});var o=$("<div/>",{title:"Zoom in"}).addClass("zoom_in").append($("<img/>",{src:"/www/images/template/zoom_in25x25.png"}).attr({width:25,height:25})).get(0);google.maps.event.addDomListener(o,"click",function(){mainMap.setZoom(mainMap.getZoom()+1)});var a=$("<div/>",{title:"Zoom out"}).addClass("zoom_out").append($("<img/>",{src:"/www/images/template/zoom_out25x25.png"}).attr({width:25,height:25})).get(0);google.maps.event.addDomListener(a,"click",function(){mainMap.setZoom(mainMap.getZoom()-1)});var i=$("<div/>",{title:"Zoom out"}).addClass("my_location").append($("<img/>",{src:"/www/images/template/my_location.png"}).attr({width:20,height:18})).get(0);google.maps.event.addDomListener(i,"click",function(){var t="undefined"!=typeof opts.point;return delete opts.point,mainMap.setZoom(defaultZoom),getDistance([userPosition.lat(),userPosition.lng()],[centerPosition.lat(),centerPosition.lng()])<=0?($("html, body").animate({scrollTop:"0px"},300),t&&postList_change(),!0):(centerPosition=userPosition,mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius()),void postList_change())}),mainMap.controls[google.maps.ControlPosition.RIGHT_TOP].push($("<div/>").addClass("customMapControl").append(o,a,i)[0]),postList_locationMarker([opts.lat,opts.lng]);var s=Object.size(postData);if(s>0)if("posts"==viewPage)$(".posts .post").each(function(){postItem_render($(this).show().attr("data-id"))}),s>=postLimit&&postList_scrollHandler(!0);else for(var n in postData)postItem_marker(n,postData[n]);google.maps.event.addListener(mainMap,"dragstart",function(){$(".post-new__dialog").remove(),$("#map_canvas :data(ui-tooltip)").tooltip("close").tooltip("option","disabled",!0),delete opts.point}),google.maps.event.addListener(mainMap,"dragend",function(){$("#map_canvas :data(ui-tooltip)").tooltip("option","disabled",!1),google.maps.event.clearListeners(mainMap,"idle"),google.maps.event.addListenerOnce(mainMap,"idle",function(){centerPosition=offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius()),postList_change()})}),google.maps.event.addListener(mainMap,"zoom_changed",function(){$("#map_canvas :data(ui-tooltip)").tooltip("close").tooltip("option","disabled",!0).tooltip("option","disabled",!1),mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius())}),$(document).click(function(){markerClick||$(".post").removeClass("higlight"),markerClick=!1}),$(window).on("resize",function(){mainMap.setZoom(defaultZoom),mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius())}),$(window).on("resize scroll",function(){$("#map_canvas :data(ui-tooltip)").tooltip("close")}),$("#slider").slider({max:2,min:.25,step:.05,value:renderRadius,slide:function(t,e){areaCircle.changeCenter(areaCircle.center,e.value)},change:function(t,e){areaCircle.changeCenter(areaCircle.center,e.value),postList_change()}}),"posts"==viewPage&&$(".post-new img").click(function(){return $(".post-new__dialog").size()?($(".post-new__dialog").fadeOut(50,function(){$(this).remove()}),!0):1==getCookie("newpost")?(newPost_dialog(),!0):void $("<div/>").append($("<p/>").html('After you write something and hit "Post" you\'ll be asked to add the location the post relates to.')).appendTo($("body")).dialog({modal:!0,resizable:!1,drag:!1,width:350,dialogClass:"dialog",buttons:{OK:function(){$("#newPost_notify").is(":checked")&&setCookie("newpost",1,365),$(this).dialog("close"),newPost_dialog()}},open:function(t){$(t.target).parent().find(".ui-dialog-buttonpane").append($("<div/>").append($("<input/>").val(1).attr({type:"checkbox",id:"newPost_notify",checked:1==getCookie("newpost")}),$("<label/>").attr({"for":"newPost_notify"}).text("Don't show this message again")).addClass("post-new__notify"))},beforeClose:function(t){$(t.target).dialog("destroy").remove()}})}),$(".postSearch input").keydown(function(t){if(13==t.keyCode){if(t.preventDefault(),!isLogin)return guestAction();var e=$(this).closest("form");return postSearch_submit(e),!1}}),$(".postSearch").submit(function(t){t.preventDefault(),opts.keywords=$(this).find("[name=keywords]").val(),opts.filter=$(this).find("[name=filter]").val(),postList_change()}),$(".postSearch [name=filter]").change(function(){$(this).closest("form").submit()}),$(".postSearch .dropdown-toggle").click(function(){$(this).find(".caret").toggleClass("up")}),$(".postSearch .dropdown-menu a").click(function(t){var e=$(this).closest(".dropdown"),o=$(this).text();t.preventDefault(),$("option",e).filter(function(){return $(this).text()==o}).prop("selected",!0).change(),$(".dropdown-toggle span:first-child",e).text(o)}),$(".user-location button").click(function(){if(!isLogin)return guestAction();var t=$(this).attr("disabled",!0);editLocationDialog({mapZoom:14,markerIcon:assetsBaseUrl+"www/images/icons/icon_1.png",inputPlaceholder:"Enter address",submitText:"Use This Address",center:centerPosition,infoWindowContent:function(t){return userAddressTooltip(t,user.image)},beforeClose:function(){t.attr("disabled",!1)},submit:function(t,e,o,a){var i=[o.lat(),o.lng()];return 0==getDistance(user.location,i)?($(e.target).dialog("close"),!0):($("html, body").animate({scrollTop:0},0),t.setOptions({draggable:!1,zoomControl:!1}),void locationTimezone(o,function(s){var n={radius:getRadius(),keywords:opts.keywords,latitude:o.lat(),longitude:o.lng(),timezone:s};"profile"==viewPage?(n.filter=0,n.user_id=profile.id):n.filter=opts.filter,a&&(n=$.extend(n,parsePlaceAddress(a))),$("html, body").animate({scrollTop:0},0),$(".posts-container .posts > .empty").remove(),ajaxJson({url:baseUrl+"post/change-user-location",data:n,done:function(t){if(user.location=i,userPosition=o,centerPosition=o,postList_reset(),mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius()),"profile"==viewPage){if(null!==t.data)for(var a in t.data){var s=t.data[a][0],n=[t.data[a][1],t.data[a][2]];postData[s]=n,postItem_marker(s,n)}}else if(t.data){for(var a in t.data){$(".posts-container .posts").append(t.data[a][3]);var s=t.data[a][0];postData[s]=[t.data[a][1],t.data[a][2]],postItem_render(s)}Object.size(t.data)>=postLimit&&postList_scrollHandler()}else emptyPostsMessage();$(e.target).dialog("close")},fail:function(){t.setOptions({draggable:!0,zoomControl:!0}),$("[name=address],[type=submit]",e.target).attr("disabled",!1)}})}))}})})})})}),googleMapsCustomMarker=function(t){this.opts=t,this.setMap(t.map)},googleMapsCustomMarker.prototype=new google.maps.OverlayView,googleMapsCustomMarker.prototype.draw=function(){var t=this;t.div||(t.div=$("<div/>").addClass(this.opts.addClass).css($.extend({position:"absolute",cursor:"pointer"},this.opts.css)).append($("<img/>").prop({src:t.opts.icon.url,width:t.opts.icon.width,height:t.opts.icon.height})),""!==$.trim(t.opts.id)&&(t.div.attr("id",t.opts.id),t.id=t.opts.id),t.div.show(),google.maps.event.addDomListener(t.div[0],"click",function(){google.maps.event.trigger(t,"click")}),google.maps.event.addDomListener(t.div[0],"mouseover",function(){google.maps.event.trigger(t,"mouseover")}),$(this.getPanes().overlayImage).append(t.div)),this.setPosition(this.opts.position),"function"==typeof this.opts.ready&&(this.opts.ready(this),delete this.opts.ready)},googleMapsCustomMarker.prototype.remove=function(){$(this.div).remove(),this.div=null,this.setMap(null)},googleMapsCustomMarker.prototype.setPosition=function(t){var e=this.getProjection().fromLatLngToDivPixel(t);e&&$(this.div).css({left:e.x-this.opts.icon.width/2,top:e.y-this.opts.icon.height}),this.opts.position=t},googleMapsCustomMarker.prototype.getPosition=function(t){return t===!0?[this.opts.position.lat(),this.opts.position.lng()]:this.opts.position},googleMapsCustomMarker.prototype.setIcon=function(t){if(this.div){this.opts.icon.width!=t.width||this.opts.icon.height!=t.height;this.opts.icon=t,$(this.div).find("img").attr({src:t.url,width:t.width,height:t.height}).css({width:t.width,height:t.height}),this.setPosition(this.opts.position)}return this},googleMapsCustomMarker.prototype.css=function(t){return $(this.div).css(t)},googleMapsCustomMarker.prototype.data=function(t,e){return"undefined"!=typeof e?(this.opts.data[t]=e,e):"undefined"!=typeof this.opts.data[t]?this.opts.data[t]:null},googleMapsAreaCircle=function(t){return this.setValues(t),this.background=this.drawCircle(this.center,1e3,1),this.makeCircle(),this},googleMapsAreaCircle.prototype=new google.maps.OverlayView,googleMapsAreaCircle.prototype.draw=function(){},googleMapsAreaCircle.prototype.makeCircle=function(){this.polyArea=this.drawPolygon([this.background,this.drawCircle(this.center,this.radius,-1)])},googleMapsAreaCircle.prototype.changeCenter=function(t,e){var o=this.drawPolygon([this.background]);this.polyArea.setMap(null),this.center=t,this.radius=e,this.makeCircle(),o.setMap(null)},googleMapsAreaCircle.prototype.drawPolygon=function(t){var e=new google.maps.Polygon({map:this.map,paths:t,strokeColor:"#0000FF",strokeOpacity:.1,strokeWeight:.1,fillColor:"#000000",fillOpacity:.3,draggable:!1});return e},googleMapsAreaCircle.prototype.drawCircle=function(t,e,o){var a=Math.PI/180,i=180/Math.PI,s=3963,n=1e3,r=e/s*i,l=r/Math.cos(t.lat()*a),d=[];if(1==o)var p=0,c=n+1;else var p=n+1,c=0;for(var u=p;1==o?c>u:u>c;u+=o){var m=Math.PI*(u/(n/2));ey=t.lng()+l*Math.cos(m),ex=t.lat()+r*Math.sin(m),d.push(new google.maps.LatLng(ex,ey))}return d}}function loadStyle(t){var e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=t,document.getElementsByTagName("head")[0].appendChild(e)}function resizeHandler(){var t=$(".posts-container").outerWidth()+16,e=$(window).width(),o=e-t;if($(".footer").width(o-2).show(),isTouch){var a=$(".posts-container .posts");a.height($(window).height()-a.offset().top)}}function offsetCenter(t,e,o,a){var i=Math.pow(2,t.getZoom()),s=t.getProjection().fromLatLngToPoint(e),n=new google.maps.Point(o/i||0,a/i||0),r=new google.maps.Point(s.x-n.x,s.y+n.y);return t.getProjection().fromPointToLatLng(r)}function offsetCenterX(t){var e=document.getElementsByClassName("posts-container")[0].offsetWidth;return windowWidth=window.outerWidth,offset=(windowWidth-e)/2-windowWidth/2,t&&(offset*=-1),offset}function offsetCenterY(t){var e=document.getElementsByClassName("map-container")[0].offsetHeight,o=document.getElementsByClassName("footer")[0].offsetHeight,a=(e-o)/2-e/2;return t&&(a*=-1),a}function getRadius(){return $("#slider").data("ui-slider")?$("#slider").slider("option","value"):renderRadius}function postSearch_searchButton(t){$(".keywords",t).append($("<img/>").addClass("search").click(function(){return isLogin?void postSearch_submit(t):guestAction()}).attr({width:14,height:14,src:assetsBaseUrl+"www/images/template/search14x14.png",alt:"search"}))}function postSearch_submit(t){var e=$("[name=keywords]",t);return""===$.trim(e.val())?(e.focus(),!1):($(".search",t).remove(),"posts"!=viewPage&&"profile"!=viewPage||($(".keywords img",t).remove(),postSearch_clearButton(t)),void t.submit())}function postSearch_clearButton(t){$(".keywords",t).append($("<img/>").addClass("clear").attr({width:14,height:14,src:assetsBaseUrl+"www/images/template/close14x14.png",alt:"clear"}).click(function(){$("[name=keywords]",t).val(""),t.submit(),$(this).remove(),postSearch_searchButton(t)}))}function postList_tooltipmarker(t){var e=new googleMapsCustomMarker({map:t.map,id:"markerGroup-"+t.id,position:new google.maps.LatLng(parseFloat(t.position[0]),parseFloat(t.position[1])),icon:t.icon,data:t.data,addClass:t.addClass,ready:function(e){$markerElement=$("#"+this.id).find("img"),$markerElement.tooltip({items:"*",show:0,hide:.1,tooltipClass:"postTooltip",content:"Loading...",position:{of:$markerElement,my:"center bottom",at:"center top",using:function(t,e){$(this).find(".arrow").remove();var o=$("<div/>").addClass("arrow");"bottom"==e.vertical?(t.top=t.top-17,o.addClass("bottom").appendTo(this)):"top"==e.vertical&&(t.top=t.top+17,o.addClass("top").prependTo(this)),0!=t.left&&t.left+$(this).outerWidth()!=$(window).width()||o.css({left:e.target.left-t.left+o.width()/3}),$(this).css(t)}},open:function(o,a){return $("#map_canvas :data(ui-tooltip)").not(o.target).tooltip("close"),$(o.target).tooltip("option","disabled")?!1:void t.content($(o.target).data("tooltip-content"),e,o,a)},close:function(e,o){"function"==typeof t.close&&t.close(e,o)}}),t.openTooltip&&($markerElement.tooltip("open"),$(document).one("click",function(){$markerElement.tooltip("close")}))}});return google.maps.event.addListener(e,"mouseover",function(){this.css({zIndex:100001})}),e}function postItem_imageDimensions(t,e){var o=t,a=e,i=150,s=150,n=980,r=Math.max($(window).height()-150,540);if(i>o&&s>a){var l=Math.max((i||o)/o,(s||a)/a);l>1&&(o*=l,a*=l)}else if(o>n||a>r){var d=Math.min((n||o)/o,(r||a)/a);1>d&&(o*=d,a*=d)}return[o,a]}function postItem_renderContent(t,e){if(!isLogin){var o=$(".post-time",e),a=new Date(o.attr("data-time"));resetTimeAgo(),o.text($.timeago(a)).attr("title",formatOutputDate(a))}$(".like,.dislike",e).click(function(){var o=$(this),a=$(".vote",e);return isLogin?a.attr("disabled")?!1:(a.attr("disabled",!0),void ajaxJson({url:baseUrl+"post/vote",data:{id:t,vote:o.hasClass("like")?1:-1},done:function(t){switch($(".like,.dislike",e).removeClass("active"),$("._3_copy",a).html(t.vote),t.active){case"-1":$(".dislike",e).addClass("active");break;case"1":$(".like",e).addClass("active")}a.attr("disabled",!1)},fail:function(){a.attr("disabled",!1)}})):guestAction()}),$(".add-comment",e).click(function(t){return t.preventDefault(),isLogin?($(".post-comment__new",e).removeClass("hidden").find("textarea").focus(),void $(this).remove()):guestAction()}),$(".social_share .email",e).click(function(e){return e.preventDefault(),isLogin?($("body").css({overflow:"hidden"}),void $("<div/>").addClass("post__share-email").append($("<img/>").attr({width:48,height:48,src:assetsBaseUrl+"www/images/mail_send.gif"}),$("<span/>").addClass("title").text("Send Message"),$("<div/>").addClass("content").append($("<form/>").append($("<div/>").append($("<input/>",{type:"email",name:"email",placeholder:"Please enter receiver email address..."})),$("<div/>").append($("<textarea/>",{name:"body",placeholder:"Please enter message..."})),$("<div/>").append($("<input/>",{type:"submit",value:"Send"}),$("<input/>",{type:"button",value:"Cancel"}).click(function(){$(".post__share-email").dialog("close")})),$("<input/>",{type:"hidden",name:"id"}).val(t)))).appendTo($("body")).dialog({modal:!0,resizable:!1,drag:!1,width:540,height:260,dialogClass:"dialog",beforeClose:function(t){$("body").css({overflow:"visible"}),$(t.target).dialog("destroy").remove()},open:function(t){$("form",t.target).submit(function(){return!1}),require(["jquery-validate"],function(){$("form",t.target).validate({rules:{email:{required:!0,email:!0},body:{required:!0}},submitHandler:function(e){ajaxJson({url:baseUrl+"post/share-email",data:$(e).serialize(),done:function(){$(t.target).empty().append($("<div/>").addClass("success").append($("<img/>",{src:assetsBaseUrl+"www/images/correct.gif"}),$("<span/>").text("Message sent")))}})}})})}})):guestAction()}),$("> .image img",e).click(function(){var t=$(window).scrollTop(),e=$(".posts-container .posts").offset().top,o=parseFloat($(this).attr("data-width")),a=parseFloat($(this).attr("data-height")),i=postItem_imageDimensions(o,a);$(".posts-container").css({top:-(t-e),position:"fixed"}),$("<div/>").append($("<img/>",{src:$(this).attr("data-src"),width:i[0],height:i[1]}).addClass("post-image")).appendTo($("body")).dialog({modal:!0,resizable:!1,drag:!1,width:i[0]+10,height:i[1]+15,dialogClass:"dialog",open:function(t){disableScroll=!0,$("body").css("overflowX","auto"),$(window).bind("resize.dialog",function(){i=postItem_imageDimensions(o,a),$(t.target).dialog("option","width",i[0]+10).dialog("option","height",i[1]+15).find(".post-image").width(i[0]).height(i[1])}),$(this).closest(".ui-dialog").css({zIndex:50001})},beforeClose:function(o){disableScroll=!1,$(".posts-container").css({top:e,position:"relative",maxHeight:"auto"}),$("body").css("overflowX","hidden"),$("html,body").animate({scrollTop:t},0),$(o.target).dialog("destroy").remove(),$(window).unbind("resize.dialog")}})}),$(".post-comment__item",e).each(function(){comment_render($(this))}),$(".social_share .facebook",e).click(function(t){var e=$(this).attr("href");t.preventDefault(),require(["facebook-sdk"],function(){FB.ui({method:"share",href:e})})}),$(".view-comments",e).click(function(o){o.preventDefault(),$(".view-comments",e).hide(),ajaxJson({url:baseUrl+"post/comments",data:{id:t,start:$(".post-comment__item",e).size()},done:function(t){if(!t.data)return!0;var o=$(".post-coments",e);for(var a in t.data)comment_render($(t.data[a]).prependTo(o));t.label&&$(".view-comments",e).html(t.label).show()}})}),$(".edit",e).click(function(o){return o.preventDefault(),$(this).attr("disabled")?!1:($(this).attr("disabled",!0),void ajaxJson({url:baseUrl+"post/edit",data:{id:t},done:function(o){$(".default-panel",e).hide();var a=$("<textarea>",{rows:1,name:"body"}).appendTo($(".post_text",e).empty()).val(o.body).bind("input paste keypress",validatePost).textareaAutoSize().focus();$(".social_share",e).append($("<div/>").addClass("edit-panel").append($("<a/>").text("Change location").click(function(e){e.preventDefault(),editLocationDialog({mapZoom:14,markerIcon:assetsBaseUrl+"www/images/icons/icon_1.png",inputPlaceholder:"Enter address",submitText:"Save Location",center:new google.maps.LatLng(o.latitude,o.longitude),infoWindowContent:function(t){return userAddressTooltip(t,user.image)},submit:function(e,a,i,s){var n={};n.latitude=o.latitude=i.lat(),n.longitude=o.longitude=i.lng(),s&&(n=$.extend(n,parsePlaceAddress(s))),e.setOptions({draggable:!1,zoomControl:!1}),ajaxJson({url:baseUrl+"post/save-location/id/"+t,data:n,done:function(e){"posts"==viewPage?getDistance([centerPosition.lat(),centerPosition.lng()],[i.lat(),i.lng()])<=getRadius()?(postItem_delete(t),postData[t][0]=i.lat(),postData[t][1]=i.lng(),postItem_marker(t,postData[t])):(centerPosition=i,mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius()),postList_change()):(post.address=e.address,centerPosition=i,postMarkers[0].setPosition(i),mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0)))),$(a.target).dialog("close")},fail:function(){e.setOptions({draggable:!0,zoomControl:!0}),$("[name=address],[type=submit]",a.target).attr("disabled",!1)}})}})}),$("<a/>").text("Delete").click(function(o){if(o.preventDefault(),!confirm("Are you sure you want to delete?"))return!1;if($(this).attr("disabled"))return!1;var a=$(".edit-panel a",e).attr("disabled",!0);ajaxJson({url:baseUrl+"post/delete",data:{id:t},done:function(){return"posts"!=viewPage?(window.location.href=baseUrl,!0):($('.post[data-id="'+t+'"]').remove(),postItem_delete(t),delete postData[t],$(".posts-container .posts input[value="+t+"]").remove(),void(0==Object.size(postData)&&emptyPostsMessage()))},fail:function(){a.attr("disabled",!1)}})}),$("<a/>").text("Done Editing").click(function(o){if(o.preventDefault(),$(this).attr("disabled"))return!1;var i=a.val();if(""===$.trim(i))return a.focus(),!1;var s=$(".edit-panel a",e).attr("disabled",!0);ajaxJson({url:baseUrl+"post/save",data:{id:t,body:i},beforeSend:function(){a.attr("disabled",!0)},done:function(t){$(".post_text",e).html(t.html),$(".edit-panel",e).remove(),$(".default-panel",e).show(),$(".edit",e).attr("disabled",!1)},fail:function(){s.attr("disabled",!1)}})})))}}))});var i=$(".post-comment__new textarea",e).bind("input paste keypress",function(o){if(!isLogin)return guestAction();var a=$(this),i=a.val();if(/[<>]/.test(i))return a.val(i.replace(/[<>]/,"")),!1;if(13===keyCode(o)&&!o.shiftKey){if(""===$.trim(i))return!1;a.attr("disabled",!0),ajaxJson({url:baseUrl+"post/comment",data:{post_id:t,comment:i},done:function(t){o.preventDefault(),a.val("").css({height:""}).attr("disabled",!1).focus(),comment_render($(t.html).insertBefore($(".post-comment__new",e)))},fail:function(){a.attr("disabled",!1)}})}});require(["textarea_autosize"],function(){i.textareaAutoSize()})}function emptyPostsMessage(){$(".posts").append($("<div/>").addClass("post empty").text("Be the first to post in this area!"))}function comment_render(t){var e=t.attr("data-id"),o=$(".post-comment__delete",t);if(isLogin)t.bind({mouseenter:function(){o.show()},mouseleave:function(){o.hide()}}),o.click(function(){return confirm("Are you sure you want to delete?")?void ajaxJson({url:baseUrl+"post/delete-comment",data:{id:e},done:function(){t.remove()}}):!1});else{$("a.post-comment__item-owner[href=#],a.post-coment-user-name[href=#]",t).click(function(t){t.preventDefault(),guestAction()});var a=$(".post-coment__date",t),i=new Date(a.attr("data-time"));resetTimeAgo(),$.timeago.settings.strings.suffixAgo="",a.text($.timeago(i)).attr("title",formatOutputDate(i))}$(".moreButton",t).click(function(o){return o.preventDefault(),$(this).attr("disabled")?!1:($(this).attr("disabled",!0),void ajaxJson({url:baseUrl+"post/read-more-comment",data:{id:e},done:function(e){$(".post-comment__body span",t).html(e.html)}}))})}function postItem_delete(t){var e=postItem_findCluester(t);if(1===postMarkersCluster[e].length)postMarkers[e].data("isRoot")?(postMarkers[e].data("id",0),postMarkersCluster[e][0]=0):(postMarkers[e].remove(),delete postMarkers[e],delete postMarkersCluster[e]);else{for(var o in postMarkersCluster[e])if(postMarkersCluster[e][o]==t){postMarkersCluster[e].splice(o,1);break}for(var o in postMarkersCluster[e]){postMarkers[e].data("id",postMarkersCluster[e][o]);break}}}function validatePost(){var t=$(this).val();return/[<>]/.test(t)?($(this).val(t.replace(/[<>]/,"")),!1):(t.length>settings.bodyMaxLength&&($(this).val(t.substring(0,settings.bodyMaxLength)),alert("Sorry! You can not enter more then "+settings.bodyMaxLength+" charactes.")),!0)}function newPost_dialog(){var t=$("<div/>").addClass("user").append($("<img/>",{width:43,height:43,src:user.image}),$("<p/>").text(user.name)),e=$("<textarea/>",{name:"body",placeholder:"Share something about a location..."}).textareaAutoSize().bind("input paste keypress",validatePost).focus(function(){var t=$(this);t.attr("placeholder-data",t.attr("placeholder")).removeAttr("placeholder")}).blur(function(){var t=$(this);t.attr("placeholder",t.attr("placeholder-data")).removeAttr("placeholder-data")}),o=$("<div/>").addClass("edit").append(e),a=$("<div/>").addClass("action").append($("<img/>",{width:27,height:20,src:assetsBaseUrl+"www/images/icon-camera.png"}).click(function(){$(this).closest("form").find("[type=file]").click()}),$("<input/>",{type:"file",name:"image",accept:"image/*",size:"1"}).hide().change(function(){var t=$(this),e=t.parent();if(e.find(".image").remove(),""===$.trim(t.val()))return!0;if($.inArray(this.files[0].type,["image/gif","image/jpeg","image/png"])<0)return alert("Invalid file type"),t.val(""),!1;var o=$("<div/>");if("undefined"!=typeof window.FileReader){var a=new FileReader;a.onload=function(t){o.prepend($("<img/>").addClass("preview").attr("src",t.target.result))},a.readAsDataURL(this.files[0])}else o.html(t.val());e.prepend($("<div/>").addClass("image").append(o.append($("<img/>",{width:12,height:12,src:assetsBaseUrl+"www/images/delete-icon12x12.png"}).addClass("delete").click(function(){$(".image",e).remove(),$("[type=file]",e).val("")}))))}),$("<input/>",{type:"submit"}).val("Post")),i=$("<div/>").addClass("post-new__dialog"),s=$("<form/>").addClass("wrapper").submit(function(t){t.preventDefault();var o=e.val();if(""===$.trim(o))return e.focus(),!1;var a=$(this).find("textarea,input").attr("disabled",!0);ajaxJson({url:baseUrl+"post/before-save",data:{body:o},done:function(t){t.post_id?$("<div/>").appendTo("body").text("Another user has already shared that same link: do you want to see that post?").dialog({width:450,modal:!0,buttons:[{text:"Cancel",click:function(){$(this).dialog("close")}},{text:"See post",id:"view-post",click:function(){return!0}},{text:"Post anyway",click:function(){newPost_addressDialog(i),$(this).dialog("close")}}],beforeClose:function(t){a.attr("disabled",!1),$(t.target).dialog("destroy").remove()},open:function(){$("#view-post").wrap($("<a/>",{href:baseUrl+"post/"+t.post_id,target:"_blank"}))}}):newPost_addressDialog(i)},fail:function(){a.attr("disabled",!1)}})});s.append(t,o),isLogin&&1==user.is_admin&&$("<div/>").addClass("options").text("options").appendTo(s).on("click",function(){var t=$(this);if(t.attr("disabled"))return!1;var e="",o=$("textarea,input[type=hidden]",s).filter(function(){return""!==$.trim($(this).val())});o.size()&&(e+="?"+o.serialize()),t.attr("disabled",!0),$("<div/>").appendTo($("body")).append($("<div/>").text("Loading..."),$("<iframe/>",{src:baseUrl+"post/post-options"+e,frameborder:0,width:"100%",id:"post-options"})).dialog({modal:!0,resizable:!1,drag:!1,width:500,dialogClass:"dialog fixed new-post-dialog",buttons:{OK:function(){var t=$(this).find("iframe").contents();$("form",t).submit()}},beforeClose:function(){$(this).dialog("destroy").remove(),t.attr("disabled",!1)}})}),s.append(a),i.append(s).appendTo("body").fadeIn(150),$(e).focus()}function newPost_addressDialog(t){editLocationDialog({mapZoom:14,markerIcon:assetsBaseUrl+"www/images/icons/icon_1.png",inputPlaceholder:"Enter address",submitText:"Post from here",cancelButton:!0,center:centerPosition,infoWindowContent:function(t){return userAddressTooltip(t,user.image)},beforeClose:function(){$("textarea,input",t).attr("disabled",!1)},submit:function(t,e,o,a){t.setOptions({draggable:!1,zoomControl:!1}),newPost_save(o,a)}})}function newPost_save(t,e){var o=$(".post-new__dialog form"),a=$("[name=image]",o),i=getDistance([centerPosition.lat(),centerPosition.lng()],[t.lat(),t.lng()])>getRadius(),s=new FormData;if(o.find("textarea,input[type=hidden]").each(function(){var t=$(this);s.append(t.attr("name"),t.val())}),s.append("latitude",t.lat()),s.append("longitude",t.lng()),e){var n=parsePlaceAddress(e);if(Object.size(n))for(var r in n)s.append(r,n[r])}""!==$.trim(a.val())&&s.append("image",a[0].files[0]),i&&s.append("reset",1),ajaxJson({url:baseUrl+"post/new",data:s,cache:!1,contentType:!1,processData:!1,done:function(e){if($("html, body").animate({scrollTop:0},0),$(".posts-container .posts > .empty").remove(),i){postList_reset(),centerPosition=t,mainMap.setCenter(offsetCenter(mainMap,centerPosition,offsetCenterX(!0),offsetCenterY(!0))),areaCircle.changeCenter(offsetCenter(mainMap,mainMap.getCenter(),offsetCenterX(),offsetCenterY()),getRadius());for(var o in e.data)$(".posts-container .posts").append(e.data[o][3]);Object.size(e.data)>=postLimit&&postList_scrollHandler()}else for(var o in e.data){$(".posts-container .posts").prepend(e.data[o][3]);break}for(var o in e.data){var a=e.data[o][0];postData[a]=[e.data[o][1],e.data[o][2]],postItem_render(a)}$(".posts-container .posts").prepend($("<input/>").attr({type:"hidden",name:"new[]"}).val(e.data[0][0])),$(".location-dialog").dialog("close"),$(".post-new__dialog").remove()}})}function postList_change(){$("html, body").animate({scrollTop:"0px"},300),postList_reset(),postList_load()}function postList_reset(){if(scrollTarget.unbind("scroll.load"),loadXhr&&loadXhr.abort(),!$.isEmptyObject(postMarkers)>0){$("#map_canvas :data(ui-tooltip)").tooltip("destroy");for(var t in postMarkers)postMarkers[t].remove()}postData={},postMarkers={},postMarkersCluster={},postList_locationMarker(),"profile"!=viewPage&&$(".posts-container .posts").html("")}function postList_load(t){t=t||0;var e=(areaCircle.center,{radius:getRadius(),keywords:opts.keywords,latitude:areaCircle.center.lat(),longitude:areaCircle.center.lng(),start:t});"profile"==viewPage?(e.filter=0,e.user_id=profile.id):(e.filter=opts.filter,e.point=opts.point,e["new"]=$(".posts-container .posts [name=new\\[\\]]").map(function(){return $(this).val()}).get()),loadXhr=ajaxJson({url:baseUrl+"post/load",data:e,done:function(t){if("profile"==viewPage){if(null!==t.data)for(var e in t.data){var o=t.data[e][0],a=[t.data[e][1],t.data[e][2]];postData[o]=a,postItem_marker(o,a)}return!0}if(t.empty)return $(".posts-container .posts").html(t.empty),!0;for(var e in t.data){var o=t.data[e][0],i=t.data[e][1],s=t.data[e][2],n=t.data[e][3];postData[o]=[i,s],$(".posts-container .posts").append(n),postItem_render(o)}Object.size(t.data)>=postLimit&&postList_scrollHandler(!0)}})}function postList_locationMarker(t){var t=[areaCircle.center.lat(),areaCircle.center.lng()];getDistance(user.location,t)<=getRadius()?postItem_marker(0,user.location,{isRoot:!0}):mainMap.getBounds().contains(userPosition)&&(postMarkers[0]=postList_tooltipmarker({map:mainMap,id:0,position:user.location,data:{isRoot:!0},icon:locationIcon,addClass:"rootMarker",content:function(t,e,o,a){return""!==$.trim(t)?($(".ui-tooltip-content",a.tooltip).html(t),!0):void $.ajax({url:baseUrl+"post/user-tooltip",type:"GET",dataType:"html"}).done(function(t){$(o.target).data("tooltip-content",t),$(".ui-tooltip-content",a.tooltip).html(t),a.tooltip.position($(o.target).tooltip("option","position"))})}}))}function postTooltip_content(t,e,o,a){!$(e.target).data("tooltip-ajax")||$(e.target).data("tooltip-ajax").abort();var i,s,n={};!opts.point||getDistance([t.lat(),t.lng()],[opts.lat,opts.lng])<=groupDistance?(n.start=a,n.latitude=t.lat(),n.longitude=t.lng(),n.keywords=opts.keywords,"profile"==viewPage?(n.filter=0,n.user_id=profile.id):(n.filter=opts.filter,n.point=opts.point,n.readmore=1),i=baseUrl+"post/tooltip",s=!0):(i=baseUrl+"post/user-tooltip",s=!1),$(e.target).data("tooltip-ajax",$.ajax({
url:i,data:n,type:"POST",dataType:"html"}).done(function(a){return $(e.target).data("tooltip-content",a),s?(postTooltip_render(a,t,e,o),!0):($(".ui-tooltip-content",o.tooltip).html(a),void o.tooltip.position($(e.target).tooltip("option","position")))}))}function postTooltip_render(t,e,o,a){clearTimeout($(o.target).data("tooltip-mouseout")),a.tooltip.bind({mouseenter:function(){!$(o.target).data("tooltip-ajax")||$(o.target).data("tooltip-ajax").abort(),clearTimeout($(o.target).data("tooltip-mouseout")),clearTimeout($(o.target).data("tooltip-close")),$(this).stop(!0)},mouseleave:function(){$(this).remove(),clearTimeout($(o.target).data("tooltip-close")),!$(o.target).data("tooltip-ajax")||$(o.target).data("tooltip-ajax").abort(),$(o.target).data("tooltip-mouseout",setTimeout(function(){$(o.target).data("tooltip-content",""),$(o.target).parent().css({zIndex:""})},.1))},click:function(){markerClick=!0}});var i=$(".ui-tooltip-content",a.tooltip).html(t);$("a.more",i).click(function(t){t.preventDefault(),postItem_higlight($(this).attr("data-id"))}),$("a.prev,a.next",i).click(function(t){t.preventDefault();var i=$(this);return i.attr("disabled")?!1:(i.attr("disabled",!0),void postTooltip_content(e,o,a,i.attr("data-start")))}),a.tooltip.position($(o.target).tooltip("option","position")),a.tooltip.focus()}function postItem_render(t){var e=postItem_marker(t,postData[t]),o=$('.post[data-id="'+t+'"]');postItem_renderContent(t,o),o.bind({mouseenter:function(){e.setIcon(postActiveIcon),e.css({zIndex:100001})},mouseleave:function(){e.setIcon(1==e.data("isRoot")?locationIcon:postIcon),e.css({zIndex:""})}}),$(".post_text .moreButton",o).click(function(t){t.preventDefault(),postItem_more(o)})}function postItem_marker(t,e,o){if(o=o||{},!$.isEmptyObject(postMarkersCluster))for(var a in postMarkersCluster)if(getDistance(e,postMarkers[a].getPosition(!0))<=groupDistance)return 0==postMarkersCluster[a][0]?(postMarkersCluster[a][0]=t,postMarkers[a].data("id",t)):postMarkersCluster[a].push(t),postMarkers[a];var i=0;if(!$.isEmptyObject(postMarkers))for(var a in postMarkers)a=parseInt(a),a>=i&&(i=a+1);postMarkersCluster[i]=[t];var s=postList_tooltipmarker({map:mainMap,id:i,position:e,data:$.extend({id:t},o),icon:1==o.isRoot?locationIcon:postIcon,addClass:o.isRoot===!0?"rootMarker":"",content:function(t,e,o,a){return""!==$.trim(t)?(postTooltip_render(t,e.getPosition(),o,a),!0):void postTooltip_content(e.getPosition(),o,a,0)},close:function(t,e){clearTimeout($(t.target).data("tooltip-mouseout")),$(t.target).data("tooltip-close",setTimeout(function(){e.tooltip.remove(),!$(t.target).data("tooltip-ajax")||$(t.target).data("tooltip-ajax").abort(),$(t.target).data("tooltip-content",""),$(t.target).parent().css({zIndex:""})},.1))}});return google.maps.event.addListener(s,"click",function(){postItem_higlight(this.data("id")),markerClick=!0}),postMarkers[i]=s,s}function postList_scrollHandler(t){scrollTarget.bind("scroll.load",function(){if(disableScroll)return!1;var t=$(this).scrollTop()+$(this).height(),e=isTouch?this.scrollHeight:$(document).height();e-t<3*$(window).height()&&($(this).unbind("scroll.load"),postList_load(Object.size(postData)))}),1==t&&scrollTarget.scroll()}function postItem_more(t){var e=$(".post_text .moreButton",t);return!e.size()||e.attr("disabled")?!1:(e.attr("disabled",!0),void ajaxJson({url:baseUrl+"post/read-more",data:{id:t.attr("data-id")},done:function(o){$(".post_text",t).html(o.html),e.remove()}}))}function postItem_higlight(t){var e=$('.post[data-id="'+t+'"]');e.size()&&$("html, body").animate({scrollTop:e.offset().top-$(".navbar").outerHeight()-1},1e3),$(".post").removeClass("higlight");var o=postItem_findCluester(t);for(var a in postMarkersCluster[o])postItem_more($('.post[data-id="'+postMarkersCluster[o][a]+'"]').addClass("higlight"))}function postItem_findCluester(t){for(var e in postMarkersCluster)for(var o in postMarkersCluster[e])if(postMarkersCluster[e][o]==t)return e;return!1}function guestAction(){return confirm("You are not logged in. Click OK to log in or sign up.")&&(window.location.href=baseUrl),!1}var mainMap,centerPosition,areaCircle,googleMapsCustomMarker,googleMapsAreaCircle,userPosition,loadXhr,scrollTarget,postData=postData||[],postMarkers={},postMarkersCluster={},defaultMinZoom=13,defaultMaxZoom=15,defaultZoom="post"==viewPage?15:14,renderRadius=opts.radius?opts.radius:1.5,postLimit=15,groupDistance=.018939,disableScroll=!1,markerClick=!1,postIcon={url:assetsBaseUrl+"www/images/template/post-icon35x50.png",width:35,height:50},locationIcon={url:assetsBaseUrl+"www/images/template/user-location-icon34x49.png",width:34,height:49},postActiveIcon={url:assetsBaseUrl+"www/images/template/post-active-icon35x51.png",width:35,height:51};loadStyle(assetsBaseUrl+"bower_components/jquery-ui/themes/base/jquery-ui.min.css"),require.config({paths:{jquery:assetsBaseUrl+"bower_components/jquery/dist/jquery.min","jquery-ui":assetsBaseUrl+"bower_components/jquery-ui/jquery-ui.min","jquery-validate":assetsBaseUrl+"bower_components/jquery-validation/dist/jquery.validate.min",textarea_autosize:assetsBaseUrl+"bower_components/textarea-autosize/src/jquery.textarea_autosize",common:assetsBaseUrl+"www/scripts/common","facebook-sdk":"https://connect.facebook.net/en_US/sdk","google.maps":"https://maps.googleapis.com/maps/api/js?key="+mapsKey+"&v=3&libraries=places&callback=initMap"}}),require(["google.maps"]),require(["jquery","common"],function(){$(function(){if(scrollTarget=$(isTouch?".posts-container .posts":window),$(window).on("resize",resizeHandler),resizeHandler(),isLogin){$("#menu-button").click(function(){$(this).next("ul").toggleClass("open")});var t=function(){ajaxJson({url:baseUrl+"contacts/friends-notification",failMessage:!1,done:function(e){var o=$(".main-menu");$(".community .count",o).html(e.friends>0?e.friends:""),$(".message .count",o).html(e.messages>0?e.messages:""),setTimeout(t,2e3)},fail:function(t){return t&&401==t.code?(window.location.href=baseUrl,!1):void 0}})};t(),$(".dropdown-toggle").click(function(t){t.preventDefault(),t.stopPropagation(),$(".dropdown-menu").not($(this).parent().find(".dropdown-menu").toggle()).hide().parent().find(".dropdown-toggle .caret.up").removeClass("up")}),$(document).click(function(t){return 2==t.button?!0:($(".dropdown-menu").hide(),void $(".dropdown-toggle .caret.up").removeClass("up"))}),$(".community .dropdown-toggle").click(function(){var t=$(this).parent();return $(".dropdown-menu",t).is(":visible")?($(".load",t).show(),$(".empty,.community-row",t).remove(),void ajaxJson({url:baseUrl+"contacts/requests",done:function(e){var o=$(".load",t).hide();if(!e.data)return o.after($("<li/>").addClass("empty").append($("<span/>").text("No new followers"))),!0;for(var a in e.data)o.after($("<li/>").addClass("community-row").append($("<a/>",{href:e.data[a].link}).append($("<div/>").addClass("thumb").append($("<img/>").attr({src:e.data[a].image,width:40,height:40})),$("<div/>").addClass("name").html(e.data[a].name+" is<br/>following you"))))}})):!0})}else $(".main-menu a").click(function(t){t.preventDefault(),t.stopPropagation(),guestAction()});"profile"==viewPage&&require(["jquery-ui"],function(){$("strong.karma").tooltip({content:function(){return $(this).prop("title")}}),$(".action .message").on("click",function(){userMessageDialog(profile.id)}),$(".action .follow").click(function(){var t=$(this);return t.attr("disabled")?!1:(t.attr("disabled",!0),void ajaxJson({url:baseUrl+"contacts/friend",data:{action:isFriend?"reject":"follow",user:profile.id,total:1},done:function(e){t.text(isFriend?"Follow":"Unfollow").attr("disabled",!1),e.total>0?$("#noteTotal").html(e.total):$("#noteTotal").hide(),isFriend=!isFriend}}))})})})}),require(["facebook-sdk"],function(){window.fbAsyncInit=function(){FB.init({appId:facebook_appId,xfbml:!0,cookie:!0,version:facebook_apiVer})}});