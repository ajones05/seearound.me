<?php
$auth = Zend_Auth::getInstance()->getIdentity();
$auth_user_id = !empty($auth['user_id']) ? $auth['user_id'] : null;
$user = $this->news->findDependentRowset('Application_Model_User')->current();
$user_image = $user->getProfileImage($this->baseUrl('www/images/img-prof40x40.jpg'));

$image = $this->news->image && file_exists(ROOT_PATH . '/newsimages/' . $this->news->image) ? $this->news->image : null;

if ($image)
{
	list($image_width, $image_height) = getimagesize(ROOT_PATH . '/newsimages/' . $image);
}
?>
<div id="scrpBox_<?php echo $this->news->id; ?>" class="scrpBox scrpBox_new">
	<ul class="myScrp">
		<li>
			<ul class="post">
				<li class="imgPro">
					<a href="<?php echo $this->baseUrl("home/profile/user/" . $user->id); ?>">
						<img src="<?php echo $user_image; ?>" class="smallImage" />
					</a>
				</li>
				<li>
					<?php if ($this->user): ?>
                    <div class="post-top">
                        <a class="title" href="<?php echo $this->baseUrl("home/profile/user/" . $user->id); ?>" style="z-index:9999;color: #0068C4;text-decoration: none;"><?=$user->Name?></a> 
                        <span class="post-date"><?php echo date("d F Y h:i a", strtotime($this->news->created_date));?></span>
                        <span class="message_number" id="message_success_<?=$this->news->id?>"><?=$this->newsVote?></span>
                         <div id="thumbs_up2_<?=$this->news->id?>"  style="float: right; margin-right: -46px; margin-top: 22px;display:none;">
                            <span id="message_success" style="color: rgb(51, 204, 0);">Already-Voted</span>
                         </div>
                         <div id="thumbsup_blck" class="deteleIcon12" style="display:inline;">
                          <?php if($this->newsVote == 0) { ?>      
                                <img id="img1_<?=$this->news->id?>" class="crp" src="<?php echo $this->baseUrl("www/images/thumsup_voted_gray.png"); ?>" <?php if ($user->id != $auth_user_id) { ?> onclick="voting(this, 'news', '<?=$this->news->id?>' ,<?=$auth_user_id?>);" <?php } else { ?> onclick="alert('You can not vote your own post!');" <?php } ?> >
                          <?php } else { ?>     
                                <img id="img1_<?=$this->news->id?>" class="crp" src="<?php echo $this->baseUrl("www/images/thumsup_voted.jpg"); ?>" <?php if ($user->id != $auth_user_id) { ?> onclick="voting(this, 'news', '<?=$this->news->id?>' ,<?=$auth_user_id?>);" <?php } else { ?> onclick="alert('You can not vote your own post!');" <?php } ?> >
                          <?php } ?> 
                                <img id="img2_<?=$this->news->id?>" class="crp" style="display: none" src="<?php echo $this->baseUrl("www/images/thumsup_voted.jpg"); ?>" <?php if ($user->id != $auth_user_id) { ?> onclick="voting(this, 'news', '<?=$this->news->id?>' ,<?=$auth_user_id?>);" <?php } else { ?> onclick="alert('You can not vote your own post!');" <?php } ?> >
                         </div>
                    </div>
					<?php endif; ?>
					<div class="post-bottom">
						<div class="post-content"><?php echo $this->news->news_html; ?></div>
					</div>
				</li>
				<li class="clr"></li>
			</ul>
		</li>
		<?php if ($image != null): ?>
		<li class="cmnt">
			<img onclick="openImage('<?php echo $image; ?>', '<?php echo $image_width; ?>', '<?php echo $image_height; ?>');" src="<?php echo $this->baseUrl("tbnewsimages/" . $image); ?>" style="width: 100%; height: auto; cursor: pointer;" />
		</li>
		<?php endif; ?>
    </ul>
	<div class="clr"></div>
	<?php if ($this->totalcomments > 5 || $auth_user_id == $user->id): ?>
	<div class="dur">
		<div class="news-footer">
			<?php if ($this->totalcomments > 5): ?>
			<div class="view-comment"><?php echo $this->comentsModel->viewMoreLabel($this->totalcomments - 5); ?></div>
			<?php endif; ?>
			<?php if ($auth_user_id == $user->id): ?>
			<input type="button" class="edit-post" value="Edit Post" />
			<?php endif; ?>
		</div>
		<div class="clr"></div>
	</div>
	<?php endif;?>
	<ul class="cmntRow">
        <?php
		if ($this->totalcomments)
		{
			for ($i = count($this->comments) - 1; $i >= 0; $i--)
			{
				echo My_ViewHelper::render('comment/item.html', array('item' => $this->comments[$i]));
			}
		}

		echo My_ViewHelper::render('comment/add-item.html');
		?>
    </ul>
	<div class="clr"></div>
</div>
<script type="text/javascript">
$(function(){
	renderNewsMap({
		center: new google.maps.LatLng(news.latitude, news.longitude)
	});

	var marker = createNewsMarker({
		map: newsMap,
		position: new google.maps.LatLng(parseFloat(news.latitude), parseFloat(news.longitude)),
		data: news,
		icon: {
			url: baseUrl + 'www/images/icons/icon_1.png',
			width: 25,
			height: 36
		},
		addClass: 'newsMarker'
	}, function(){
		return newsUserTooltipContent(newsOwner.image, newsOwner.name, news.address);
	});

	$(document).click(function(){
		var $markerElement = $('#' + marker.id);

		if ($markerElement.data('ui-tooltip')){
			$markerElement.tooltip('close');
		}
	});

	google.maps.event.addListener(newsMap, 'idle', function(){
		google.maps.event.trigger(marker, 'mouseover');
	});

	renderNews($('.scrpBox'));

	setThisHeight(Number($("#midColLayout").height() + 20));
});
</script>
