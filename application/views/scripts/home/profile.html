<?php
$karma_post = $this->karma_posts->news_count +
	(.25 * ($this->karma_posts->votings_count + $this->karma_posts->comments_count)) +
	$this->karma_posts->other_comments_count * .25;

$karma_post_title = 'User posts: ' . $this->karma_posts->news_count . '<br/>' .
	'User posts comments: ' . $this->karma_posts->comments_count . '<br/>' .
	'User posts votings: ' . $this->karma_posts->votings_count . '<br/>' .
	'User comments on other posts: ' . $this->karma_posts->other_comments_count;
?>
<div class="profile">
<div class="leftCol">
	<div class="profDtl">
		<div class="profile-img">
			<span id="image_upload_field">
				<img src="<?php echo $this->profile->getProfileImage($this->baseUrl('www/images/img-prof40x40.jpg')); ?>" />
			</span>
		</div>
		<div class="profile-describe">
			<h3 class="name"><?php echo ucfirst($this->profile->Name); ?></h3>
			<p class="loc"><?php echo ucfirst(My_StringHelper::stringLimit($this->profile->address(), 50, '...')); ?></p>
		</div>
		<div class="clr"></div>
	</div>
</div>
<ul class="viewForm" style="width:100%; margin-left: 0px;">
	<li>
		<label>Karma</label>
		<span class="karma">
			<b title="<?php echo htmlspecialchars($karma_post_title); ?>"><?php echo round($karma_post, 4); ?></b>(Calculated based on posts &amp; comments)
		</span>
		<div class="clr"></div>
	</li>
	<?php if ($this->auth_id == $this->profile->id): ?>
	<li>
		<label>Email Address</label>
		<span><?php echo $this->profile->Email_id; ?></span>
		<div class="clr"></div>
	</li>
	<?php endif; ?>
    <li>
        <label>Gender</label>
        <span><?php echo $this->profile->gender(); ?></span>
		<div class="clr"></div>
    </li>
    <li>
		<label>Interests</label>
        <span><?php echo $this->profile->activities(); ?></span>
		<div class="clr"></div>
    </li>
    <?php if ($this->profile->address()): ?>
	<li>
        <label>Location</label>
        <span><?php echo $this->profile->address(); ?></span>
		<div class="clr"></div>
    </li>
    <?php endif; ?>
    <li>
        <label>Age</label>
		<?php if ($this->profile->Birth_date): ?>
        <span><?php echo My_CommonUtils::dateConversion(strtotime($this->profile->Birth_date)); ?></span>
		<?php endif; ?>
		<div class="clr"></div>
    </li>
</ul>
<?php if ($this->profile->id == $this->auth_id): ?>
<div class="btnBarM20">
	<a href="<?php echo $this->baseUrl("home/edit-profile"); ?>">Edit Profile Info</a>
</div>
<?php elseif ($this->auth_id): ?>
<div class="friendAction btnBarM20">
<?php if ($this->isFriend): ?>
<input class="friend" type="button" value="Unfollow" />
<?php else: ?>
<input class="friend" type="button" value="Follow" />
<?php endif; ?>
<input class="message" type="button" value="Message" />
</div>
<?php endif; ?>
</div>
<script type="text/javascript">
$(function(){
	$('.karma b').tooltip({
		content: function(){return $(this).prop('title'); }
	});
	$('.friendAction input.friend').click(function(){
		var target = $(this).attr('disabled', true);
		$('.friendAction').prepend(
			$('<img/>', {src: baseUrl + 'www/images/wait.gif'})
				.addClass('frndReqImg')
		);
		ajaxJson({
			url: baseUrl + 'contacts/friend',
			data: {
				action: isFriend ? 'reject' : 'follow',
				user: reciever_userid,
				total: true
			},
			done: function(response){
				target.val(isFriend ? 'Follow' : 'Unfollow')
					.attr('disabled', false);
				$('.frndReqImg').remove();
				if (response.total > 0){
					$('#noteTotal').html(response.total);
				} else {
					$('#noteTotal').hide();
				}
				isFriend = !isFriend;
			}
		});
	});
});
function initMap(){
	var otherProfile = reciever_userid != user_id;

	var map = new google.maps.Map($('#map_canvas')[0], {
		zoom: 14,
		minZoom: 13,
		maxZoom: 15,
		center: otherProfile ? new google.maps.LatLng(user_profile.lat, user_profile.lng) :
			new google.maps.LatLng(userLatitude, userLongitude),
        disableDefaultUI: true,
        panControl: false,
    	zoomControl: false,
        scaleControl: false,
    	streetViewControl: false,
    	overviewMapControl: false,
	    mapTypeId: google.maps.MapTypeId.ROADMAP
    });

	google.maps.event.addListenerOnce(map, 'idle', function(){
		var marker = new google.maps.Marker({
			position: map.getCenter(),
			map: map,
			icon: baseUrl + 'www/images/icons/icon_1.png'
		});

		if (!otherProfile){
			var infowindow = new google.maps.InfoWindow({
				content: userAddressTooltip(userAddress, imagePath)
			});

			infowindow.open(map, marker);
		}
	});

	if (otherProfile){
		$('.friendAction .message').click(function(){
			userMessageDialog(user_profile.id);
		});
	}
}
</script>
