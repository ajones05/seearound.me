<?php
$karmaTitle = 'User posts: ' . $this->karma['post'] . '<br/>' .
	'User posts comments: ' . $this->karma['comment'] . '<br/>' .
	'User posts votings: ' . $this->karma['vote'] . '<br/>' .
	'User comments on other posts: ' . $this->karma['comment_other'];
$age = $this->profile->Birth_date ?
	(new DateTime($this->profile->Birth_date))->diff(new DateTime())->y : null;
$thumb = Application_Model_User::getThumb($this->profile, '55x55');
?>
<div class="profile">
<div class="leftCol">
	<div class="profDtl">
		<div class="profile-img">
			<span id="image_upload_field">
				<img src="<?php echo $this->baseUrl($thumb); ?>">
			</span>
		</div>
		<div class="profile-describe">
			<h3 class="name"><?php echo ucfirst($this->profile->Name); ?></h3>
			<p class="loc"><?php echo My_StringHelper::stringLimit($this->addressFormat, 50, '...'); ?></p>
		</div>
		<div class="clr"></div>
	</div>
</div>
<ul class="viewForm" style="width:100%; margin-left: 0px;">
<li>
<label>Karma</label>
<span class="karma">
<b title="<?php echo htmlspecialchars($karmaTitle); ?>"><?php echo round($this->karma['karma'], 4); ?></b
>(Calculated based on posts &amp; comments)
</span>
<div class="clr"></div>
</li>
	<?php if ($this->auth_id == $this->profile->id): ?>
	<li>
		<label>Email Address</label>
		<span><?php echo $this->profile->Email_id; ?></span>
		<div class="clr"></div>
	</li>
	<?php endif; ?>
    <li>
        <label>Gender</label>
        <span><?php echo $this->profile->gender(); ?></span>
		<div class="clr"></div>
    </li>
    <li>
		<label>Interests</label>
        <span><?php echo $this->profile->activities(); ?></span>
		<div class="clr"></div>
    </li>
    <?php if ($this->addressFormat !== ''): ?>
	<li>
        <label>Location</label>
        <span><?php echo $this->addressFormat; ?></span>
		<div class="clr"></div>
    </li>
    <?php endif; ?>
	<?php if ($age): ?>
    <li>
        <label>Age</label>
        <span><?php echo $age; ?> Year<?php if ($age !== 1) echo 's'; ?></span>
		<div class="clr"></div>
    </li>
	<?php endif; ?>
</ul>
<?php if ($this->profile->id == $this->auth_id): ?>
<div class="btnBarM20">
	<a href="<?php echo $this->baseUrl("home/edit-profile"); ?>">Edit Profile Info</a>
</div>
<?php elseif ($this->auth_id): ?>
<div class="friendAction btnBarM20">
<?php if ($this->isFriend): ?>
<input class="friend" type="button" value="Unfollow" />
<?php else: ?>
<input class="friend" type="button" value="Follow" />
<?php endif; ?>
<input class="message" type="button" value="Message" />
</div>
<?php endif; ?>
</div>
<script type="text/javascript">
$(function(){
	$('.karma b').tooltip({
		content: function(){return $(this).prop('title'); }
	});
	$('.friendAction input.friend').click(function(){
		var target = $(this).attr('disabled', true);
		$('.friendAction').prepend(
			$('<img/>', {src: baseUrl + 'www/images/wait.gif'})
				.addClass('frndReqImg')
		);
		ajaxJson({
			url: baseUrl + 'contacts/friend',
			data: {
				action: isFriend ? 'reject' : 'follow',
				user: reciever_userid,
				total: 1
			},
			done: function(response){
				target.val(isFriend ? 'Follow' : 'Unfollow')
					.attr('disabled', false);
				$('.frndReqImg').remove();
				if (response.total > 0){
					$('#noteTotal').html(response.total);
				} else {
					$('#noteTotal').hide();
				}
				isFriend = !isFriend;
			}
		});
	});
});
function initMap(){
	var otherProfile = reciever_userid != user_id;

	var map = new google.maps.Map($('#map_canvas')[0], {
		zoom: 14,
		minZoom: 13,
		maxZoom: 15,
		center: new google.maps.LatLng(profileData.latitude,profileData.longitude),
        disableDefaultUI: true,
        panControl: false,
    	zoomControl: false,
        scaleControl: false,
    	streetViewControl: false,
    	overviewMapControl: false,
	    mapTypeId: google.maps.MapTypeId.ROADMAP
    });

	google.maps.event.addListenerOnce(map, 'idle', function(){
		var marker = new google.maps.Marker({
			position: map.getCenter(),
			map: map,
			icon: baseUrl + 'www/images/icons/icon_1.png'
		});

		if (!otherProfile){
			var infowindow = new google.maps.InfoWindow({
				content: userAddressTooltip(profileData.address, imagePath)
			});

			infowindow.open(map, marker);
		}
	});

	if (otherProfile){
		$('.friendAction .message').click(function(){
			userMessageDialog(profileData.id);
		});
	}
}
</script>
