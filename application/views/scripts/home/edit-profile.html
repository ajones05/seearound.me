<script type="text/javascript">
	$(function(){
		$('#birth_month, #birth_year').change(function(){
			if ($('#birth_month').val() && $('#birth_year').val()){
				var count = new Date($('#birth_year').val(), $('#birth_month').val(), 0).getDate();

				if (($('#birth_day option').size() - 1) != count){
					var selected = $('#birth_day').val();

					$('#birth_day option:not(:first-child)').remove();

					for (var day = 1; day <= count; day++){
						$('#birth_day').append($('<option/>', {selected: day == selected}).val(day).text(day))
					}
				}
			}
		});

		$('#birth_month').change();

		$("#locationButton, #Location").click(function(){
			$('body').css({overflow: 'hidden'});

			$('<div/>', {'class': 'location-dialog'})
				.append(
					$('<div/>', {id: 'map-canvas'}),
					$('<div/>', {'class': 'panel'}).append(
						$('<form/>').append(
							$('<input/>', {type: 'text', name: 'address', placeholder: 'Enter your Address'}),
							$('<img/>', {'class': 'search', src: '/www/images/map_search.png'}),
							$('<input/>', {type: 'submit', value: 'Use This Address'})
						)
					)
				)
				.appendTo($('body'))
				.dialog({
					modal: true,
					resizable: false,
					drag: false,
					width: 980,
					height: 500,
					dialogClass: 'colorbox',
					beforeClose: function(event, ui){
						$('body').css({overflow: 'visible'});
						$(event.target).dialog('destroy').remove();
					},
					open: function(event, ui){
						var $editForm = $('#editProfileForm'),
							$addressField = $('[name=location]', $editForm),
							$latitudeField = $('[name=latitude]', $editForm),
							$longitudeField = $('[name=longitude]', $editForm),
							newsAddress = $addressField.val(),
							$editAddress = $('[name=address]', event.target)
								.val(newsAddress)
								.attr('disabled', false),
							$submitField = $('[type=submit]', event.target)
								.attr('disabled', false),
							$map = $('#map-canvas', event.target),
							autocomplete = googleMapsPlacesAutocompleteReset($editAddress[0]),
							centerLocation = new google.maps.LatLng($latitudeField.val(), $longitudeField.val()),
							geocoder = new google.maps.Geocoder(),
							renderLocation = true;

						var map = new google.maps.Map($map[0], {
							zoom: 14,
							center: centerLocation
						});

						var marker = new google.maps.Marker({
							map: map,
							draggable: true,
							position: map.getCenter(),
							icon: baseUrl + 'www/images/icons/icon_1.png'
						});

						function updateMarker(event){
							geocoder.geocode({
								latLng: event.latLng
							}, function(results, status){
								if (status == google.maps.GeocoderStatus.OK){
									infowindow.setContent(userAddressTooltip(results[0].formatted_address, imagePath));
									$editAddress.val(results[0].formatted_address);
								} else {
									infowindow.setContent(userAddressTooltip('', imagePath));
									$editAddress.val('');
								}

								autocomplete = googleMapsPlacesAutocompleteReset($editAddress[0]);
								renderLocation = true;
								infowindow.open(map, marker);
							});
						}

						var infowindow = new google.maps.InfoWindow({
							maxWidth: 220,
							content: userAddressTooltip(newsAddress, imagePath)
						});

						infowindow.open(map, marker);

						google.maps.event.addListener(map, 'click', function(mapEvent){
							infowindow.close();
							marker.setPosition(mapEvent.latLng);
							updateMarker(mapEvent);
						});

						google.maps.event.addListener(marker, 'dragend', function(markerEvent){
							updateMarker(markerEvent);
						});

						google.maps.event.addListener(autocomplete, 'place_changed', function(){
							$('.search', event.target).click();
						});

						$editAddress.keydown(function(e){
							if (e.keyCode == 13){
								e.preventDefault();
							}
						});

						$('.search', event.target).click(function(){
							var value = $.trim($editAddress.val());

							if (value === ''){
								$editAddress.focus();
								return;
							}

							$submitField.attr('disabled', true);

							geocoder.geocode({
								address: value
							}, function(results, status){
								if (status == google.maps.GeocoderStatus.OK){
									infowindow.setContent(userAddressTooltip(results[0].formatted_address, imagePath));
									map.setCenter(results[0].geometry.location);
									marker.setPosition(results[0].geometry.location);
									$editAddress.val(results[0].formatted_address);
									autocomplete = googleMapsPlacesAutocompleteReset($editAddress[0]);
									renderLocation = true;
								} else {
									alert('Sorry! We are unable to find this location.');
									renderLocation = false;
								}

								$submitField.attr('disabled', false);
							});
						});

						$('form', event.target).submit(function(e){
							e.preventDefault();

							if (!renderLocation){
								$editAddress.focus();
								return false;
							}

							$addressField.val($editAddress.val());
							$latitudeField.val(marker.getPosition().lat());
							$longitudeField.val(marker.getPosition().lng());

							$(event.target).dialog('close');
						});
					}
				});
		});

		var map = new google.maps.Map($('#map_canvas')[0], {
			zoom: 14,
			minZoom: 13,
			maxZoom: 15,
			center: new google.maps.LatLng(userLatitude, userLongitude),
			disableDefaultUI: true,
			panControl: false,
			zoomControl: false,
			scaleControl: false,
			streetViewControl: false,
			overviewMapControl: false,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		});

		google.maps.event.addListenerOnce(map, 'idle', function(){
			var marker = new google.maps.Marker({
				position: map.getCenter(),
				map: map,
				icon: baseUrl + 'www/images/icons/icon_1.png'
			});
			
			var infowindow = new google.maps.InfoWindow({
				content: userAddressTooltip(userAddress, imagePath)
			});

			infowindow.open(map, marker);
		});

		setHeight('.eqlCH');

		$('#imageButton').click(function() {
			$('#ImageFile').trigger('click');
		});

		$('#ImageFile').bind('change', function() { 
			$(".proImgChange").toggle();

			$("#imageform").ajaxForm({
				success : function(data){
					$(".proImgChange").toggle();
					data = $.parseJSON(data);
					var html ='<img src="'+data.url+'" class="imgProf"/>';
					$("#image_upload_field").html(html);
				}
			}).submit();
		});	

		$("#imageSection").mouseover(function(){
			$("#imageButton").show();
		});	

		$("#imageSection").mouseout(function(){
			$("#imageButton").hide();
		});	
	});
</script>
<h3 class="topHdGrayB12">Edit Profile Info</h3>
<div id="userDiv" class="leftCol" >
	<div class="profDtl"> 
		<div class="profile-img">
			<a style="z-index:9999;" href="<?php echo $this->baseUrl("home/profile"); ?>">
				<span id="image_upload_field">
					<img src="<?php echo $this->user->getprofileImage($this->baseUrl("www/images/img-prof40x40.jpg")); ?>" class="imgProf" />
				</span>
			</a> 
		</div>
		<div class="profile-describe">   
			<a class="hypDecNone" href="<?php echo $this->baseUrl("home/profile"); ?>">
				<h3 class="name"><?php echo ucfirst($this->user->Name);?></h3>
			</a>
			<p class="loc"><?php echo ucfirst(My_StringHelper::stringLimit($this->user->address(), 50, '...')); ?></p>
		</div>
		<div class="clr"></div>
	</div>
</div>
<ul class="editProfInfoTopNav">
	<li class="txtBold">Profile Picture</li>
	<li>
		<div style="height: 1px; width: 1px;"> 
			<form enctype='multipart/form-data' action='<?php echo $this->baseUrl("home/image-upload"); ?>' id='imageform' method='POST'>
				<input style="height: 0px; width: 1px;background-color: white;color: white;" type='file' id='ImageFile' name='ImageFile' accept='image/*'/>                
			</form>
		</div>
		<a id="imageButton" href="javascript:void(0);" class="btnBlue">Choose New File </a>
	</li>
	<li>
		<img src="<?php echo $this->baseUrl("www/images/wait.gif"); ?>" class="proImgChange" />
	</li>
	<li>
		<div class='answers'></div>
	</li>
	<div class="clr"></div>
</ul>
<form method="post" id="editProfileForm">
	<ul class="editProfInfoForm">
		<li>
			<?php echo $this->form->email; ?>
			<?php echo $this->form->public_profile; ?>
		</li>
		<li><?php echo $this->form->name; ?></li>
		<li><?php echo $this->form->gender; ?></li>
		<li><?php echo $this->form->activities; ?></li>
		<li>
			<?php echo $this->form->address; ?>
			<dd>
			<input id="latitude" type="hidden" value="<?php echo $this->form->latitude->getValue(); ?>" name="latitude" />
			<?php echo $this->form->latitude->renderErrors(); ?>
			<input id="longitude" type="hidden" value="<?php echo $this->form->longitude->getValue(); ?>" name="longitude" />
			<?php echo $this->form->longitude->renderErrors(); ?>
			</dd>
		</li>
		<li>
			<dt>
				<label>Date of Birth</label>
			</dt>
			<dd class="dob">
				<?php
				echo $this->formSelect(
					'birth_month',
					$this->form->birth_month->getValue(),
					$this->form->getErrors('birth_month') ? array('class' => 'error') : null,
					$this->form->birth_month->getMultiOptions()
				);
				echo $this->formSelect(
					'birth_day',
					$this->form->birth_day->getValue(),
					$this->form->getErrors('birth_day') ? array('class' => 'error') : null,
					$this->form->birth_day->getMultiOptions()
				);
				echo $this->formSelect(
					'birth_year',
					$this->form->birth_year->getValue(),
					$this->form->getErrors('birth_year') ? array('class' => 'error') : null,
					$this->form->birth_year->getMultiOptions()
				);
				?>
			</dd>
		</li>
	</ul>
	<div class="clr"></div>
	<div class="btnBarM20">
		<input type="submit" value="Apply" class="btnBlueRptType2" style="margin-right:8%" />
		<input type="button" onclick="window.location.href = '<?php echo $this->baseUrl("home/profile"); ?>'" value="Cancel" class="btnBlueRptType2" />
	</div>
</form>
